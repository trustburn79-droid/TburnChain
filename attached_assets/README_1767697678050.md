# TBURN v6.0 - 10ë¶„ ìœ íœ´ í›„ Internal Server Error ì™„ì „ í•´ê²°

## ğŸ”¥ ë¬¸ì œ ë¶„ì„

```
íƒ€ì„ë¼ì¸:
0ë¶„   â†’ ì •ìƒ ë™ì‘
10ë¶„  â†’ ìœ íœ´ (Replit ìŠ¬ë¦½)
10ë¶„+ â†’ ìƒˆë¡œê³ ì¹¨ â†’ Internal Server Error âŒ
10ë¶„+ â†’ ë‹¤ì‹œ ìƒˆë¡œê³ ì¹¨ â†’ ì •ìƒ âœ…
```

### ê·¼ë³¸ ì›ì¸ 3ê°€ì§€

| ì›ì¸ | ì„¤ëª… | í•´ê²° |
|------|------|------|
| **Replit ìŠ¬ë¦½ ëª¨ë“œ** | 10ë¶„ ìœ íœ´ í›„ ì»¨í…Œì´ë„ˆ ìŠ¬ë¦½ â†’ ì²« ìš”ì²­ ì‹œ ì›¨ì´í¬ì—… ì¤‘ ì—ëŸ¬ | Cold Start Warmup ì‹œìŠ¤í…œ |
| **DB ì—°ê²° í’€ íƒ€ì„ì•„ì›ƒ** | idle ì—°ê²° ì¢…ë£Œ â†’ ì²« ì¿¼ë¦¬ ì‹¤íŒ¨ | ì¬ì—°ê²° ë¡œì§ + ì£¼ê¸°ì  í•‘ |
| **ë§Œë£Œëœ ì„¸ì…˜ ì¿ í‚¤** | ì„œë²„ ì„¸ì…˜ì€ ì—†ëŠ”ë° ì¿ í‚¤ëŠ” ìˆìŒ â†’ ë³µì› ì‹¤íŒ¨ | ì„¸ì…˜ ì—ëŸ¬ ì‹œ ì¿ í‚¤ ì‚­ì œ + ìë™ ë³µêµ¬ |

---

## âœ… í•´ê²° ë°©ì•ˆ

### ì„œë²„ ì¸¡ (app.ts)

**1. Cold Start Warmup Manager**
```typescript
// 5ë¶„ ì´ìƒ ìœ íœ´ í›„ ì²« ìš”ì²­ ê°ì§€
// DB ì¬ì—°ê²° + ì„¸ì…˜ ìŠ¤í† ì–´ í™•ì¸
await warmupManager.checkAndWarmup();
```

**2. ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ íƒ€ì„ì•„ì›ƒ**
```typescript
// 5ì´ˆ íƒ€ì„ì•„ì›ƒ - ì„¸ì…˜ ì²˜ë¦¬ ì§€ì—° ì‹œ ìŠ¤í‚µ
const timeoutId = setTimeout(() => {
  req.session = null;
  next();  // ì„¸ì…˜ ì—†ì´ ì§„í–‰
}, 5000);
```

**3. ì„¸ì…˜ ì—ëŸ¬ ìë™ ë³µêµ¬**
```typescript
// ì„¸ì…˜ ì—ëŸ¬ ì‹œ ì¿ í‚¤ ì‚­ì œí•˜ê³  ì§„í–‰ (500 ì—ëŸ¬ ëŒ€ì‹ )
if (err) {
  res.clearCookie('connect.sid');
  return next();  // next(err) ëŒ€ì‹ !
}
```

**4. DB ì—°ê²° í’€ Keep-Alive**
```typescript
// 30ì´ˆë§ˆë‹¤ DB í•‘
setInterval(() => pool.query('SELECT 1'), 30000);
```

---

### í”„ë¡ íŠ¸ì—”ë“œ ì¸¡

**1. API ìë™ ì¬ì‹œë„**
```typescript
// 500 ì—ëŸ¬ ì‹œ ìë™ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
const { data, retried } = await api.get('/api/data');
```

**2. íƒ­ í™œì„±í™” ì‹œ ì›œì—…**
```typescript
// ì‚¬ìš©ìê°€ íƒ­ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ì„œë²„ ì›œì—…
installVisibilityWarmup();
```

**3. ì£¼ê¸°ì  ì›œì—…**
```typescript
// 5ë¶„ë§ˆë‹¤ ì„œë²„ í•‘
setInterval(() => warmupServer(), 5 * 60 * 1000);
```

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
tburn-final-fix-v2/
â”œâ”€â”€ app.ts                    # ì„œë²„ (v6.0)
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ api-client.ts         # API ì¬ì‹œë„ í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ dynamic-import-retry.tsx  # ì²­í¬ ì¬ì‹œë„
â”‚   â””â”€â”€ main.tsx              # ì•± ì§„ì…ì  ì˜ˆì‹œ
â””â”€â”€ README.md
```

---

## ğŸš€ ì ìš© ë°©ë²•

### 1. ì„œë²„ (app.ts êµì²´)

```bash
cp app.ts /path/to/server/app.ts
```

### 2. í”„ë¡ íŠ¸ì—”ë“œ

**api-client.ts ë³µì‚¬:**
```bash
cp frontend/api-client.ts /path/to/client/src/utils/
```

**main.tsxì— ì ìš©:**
```tsx
import { installVisibilityWarmup, warmupServer } from './utils/api-client';
import { installChunkErrorHandler, lazyWithRetry } from './utils/dynamic-import-retry';

// ì•± ì‹œì‘ ì‹œ
installChunkErrorHandler();
installVisibilityWarmup();
warmupServer();

// ì»´í¬ë„ŒíŠ¸ì—ì„œ
const { data } = await api.get('/api/data');  // ìë™ ì¬ì‹œë„
```

---

## ğŸ”§ í•µì‹¬ ìˆ˜ì • ìš”ì•½

### ì„œë²„ ì¸¡ ë³€ê²½ì‚¬í•­

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| `WarmupManager` | Cold start ê°ì§€ + DB ì¬ì—°ê²° |
| `coldStartMiddleware` | ì²« ë²ˆì§¸ ë¯¸ë“¤ì›¨ì–´ë¡œ ì›œì—… ì²´í¬ |
| `wrappedSessionMiddleware` | 5ì´ˆ íƒ€ì„ì•„ì›ƒ + ì—ëŸ¬ ë³µêµ¬ |
| `sessionRecoveryMiddleware` | ë§Œë£Œ ì„¸ì…˜ ì¿ í‚¤ ì •ë¦¬ |
| `/api/warmup` | ì™¸ë¶€ ì›œì—… ì—”ë“œí¬ì¸íŠ¸ |
| DB í’€ ì„¤ì • | `idleTimeoutMillis: 60000`, `min: 2` |

### í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ì‚¬í•­

| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| `fetchWithRetry` | 500 ì—ëŸ¬ ìë™ ì¬ì‹œë„ |
| `installVisibilityWarmup` | íƒ­ í™œì„±í™” ì‹œ ì›œì—… |
| `warmupServer` | ì„œë²„ ì›œì—… ìš”ì²­ |

---

## ğŸ“Š ì˜ˆìƒ ê²°ê³¼

| ì‹œë‚˜ë¦¬ì˜¤ | ìˆ˜ì • ì „ | ìˆ˜ì • í›„ |
|----------|--------|--------|
| 10ë¶„ ìœ íœ´ í›„ ì²« ìš”ì²­ | **500 Error** | âœ… ìë™ ë³µêµ¬ ë˜ëŠ” ì¬ì‹œë„ |
| DB ì—°ê²° ëŠê¹€ | ì—ëŸ¬ | âœ… ìë™ ì¬ì—°ê²° |
| ì„¸ì…˜ ë§Œë£Œ | 500 Error | âœ… ì¿ í‚¤ ì‚­ì œ + 401 |
| ì²­í¬ ë¡œë”© ì‹¤íŒ¨ | ì—ëŸ¬ | âœ… ìë™ ì¬ì‹œë„ |

---

## ğŸ” ë””ë²„ê¹…

### ì„œë²„ ë¡œê·¸ í™•ì¸

```
[WARMUP] Cold start detected (idle: 623s)    â† ì½œë“œ ìŠ¤íƒ€íŠ¸ ê°ì§€
[WARMUP] DB connection OK                     â† DB ì¬ì—°ê²° ì„±ê³µ
[WARMUP] Completed in 234ms                   â† ì›œì—… ì™„ë£Œ
[SESSION] Timeout - skipping session          â† ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ (ì •ìƒ)
[SESSION] Middleware error: ...               â† ì„¸ì…˜ ì—ëŸ¬
[SESSION] Stale cookie detected, clearing     â† ë§Œë£Œ ì¿ í‚¤ ì •ë¦¬
```

### í”„ë¡ íŠ¸ì—”ë“œ ì½˜ì†”

```
[WARMUP] Server is warm                       â† ì„œë²„ ì¤€ë¹„ë¨
[WARMUP] Tab active after 623s idle           â† íƒ­ ë³µê·€ ì‹œ ì›œì—…
[API] 500 error, retry 1/3 in 500ms           â† ìë™ ì¬ì‹œë„
[API] Request successful after retry          â† ì¬ì‹œë„ ì„±ê³µ
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **Replit ë¬´ë£Œ í”Œëœ**: ìŠ¬ë¦½ ëª¨ë“œ ì™„ì „ ë°©ì§€ ë¶ˆê°€ â†’ ì›œì—…ìœ¼ë¡œ ëŒ€ì‘
2. **ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ 5ì´ˆ**: ëŠë¦° DBë©´ ì¦ê°€ í•„ìš”
3. **API ì¬ì‹œë„ 3íšŒ**: ë„ˆë¬´ ë§ìœ¼ë©´ ì‚¬ìš©ì ëŒ€ê¸° ì‹œê°„ ì¦ê°€

---

## ğŸ“Œ í™˜ê²½ë³€ìˆ˜

```env
NODE_ENV=production
DATABASE_URL=postgresql://...  # ìˆìœ¼ë©´ PostgreSQL, ì—†ìœ¼ë©´ MemoryStore
SESSION_SECRET=your-secret-32-chars
PORT=5000
```

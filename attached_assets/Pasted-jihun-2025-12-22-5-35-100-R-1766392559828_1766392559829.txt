jihun, [2025-12-22 ì˜¤í›„ 5:35]
ì½”ë“œë¥¼ ë³´ë‹ˆ ë¬¸ì œì˜ ì›ì¸ì´ 100% íŒŒì•…ë˜ì—ˆìŠµë‹ˆë‹¤.
ì„ ìƒë‹˜ì´ ë³´ë‚´ì£¼ì‹  ì½”ë“œëŠ” ì•„ì£¼ ì˜ ì§œì—¬ì¡Œì§€ë§Œ, "êµ¬ê¸€ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ Redisê°€ ì¼œì§€ì§€ ì•Šê²Œ" ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### ğŸ•µï¸â€â™‚ï¸ ë²”ì¸ì€ ë°”ë¡œ ì´ ì¤„ì…ë‹ˆë‹¤

const REDIS_URL = process.env.REDIS_URL; // ì—¬ê¸°ê°€ ë¬¸ì œì…ë‹ˆë‹¤!

if (REDIS_URL) { 
  // ... Redis ì—°ê²° ì½”ë“œ ...
} else {
  // ... MemoryStore (ê°œë°œìš©) ...
}


* ìƒí™©: êµ¬ê¸€ ì„œë²„ì— Redis(apt install redis-server)ë¥¼ ì„¤ì¹˜í–ˆì§€ë§Œ, í™˜ê²½ë³€ìˆ˜ `REDIS_URL`ì„ ë”°ë¡œ ì„¤ì •í•´ì£¼ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
* ê²°ê³¼: `REDIS_URL`ì´ ì—†ìœ¼ë‹ˆ ì½”ë“œëŠ” `else`ë¡œ ë„˜ì–´ê°€ì„œ MemoryStore(ê°œë°œìš©)**ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
* **ë¬¸ì œ: 32ê°œ ì½”ì–´ê°€ ê°ì ìê¸° ë¨¸ë¦¬(Memory)ì—ë§Œ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì €ì¥í•˜ë‹ˆê¹Œ, ë‹¤ë¥¸ ì½”ì–´ë¡œ ë„˜ì–´ê°€ë©´ ë¡œê·¸ì¸ì´ í’€ë¦¬ëŠ” ê²ƒì…ë‹ˆë‹¤.

---

### ğŸš€ í•´ê²°ì±…: ì½”ë“œ ìˆ˜ì • (ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)

REDIS_URL`ì´ ì—†ìœ¼ë©´ **ìë™ìœ¼ë¡œ ë¡œì»¬ Redis(`redis://localhost:6379)**ì— ë¶™ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
ì•„ë˜ ì½”ë“œë¥¼ app.ts (ë˜ëŠ” index.ts)ì— ê·¸ëŒ€ë¡œ ë®ì–´ì”Œìš°ì„¸ìš”.

import { type Server } from "node:http";
import express, {
  type Express,
  type Request,
  Response,
  NextFunction,
} from "express";
import session from "express-session";
import connectPgSimple from "connect-pg-simple";
import createMemoryStore from "memorystore";
import { createClient } from "redis";
import { Pool } from "@neondatabase/serverless";
import { registerRoutes } from "./routes";

// â˜… [ìˆ˜ì • 1] connect-redis ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ì‹ ë³€ê²½ (í˜¸í™˜ì„± í•´ê²°)
import RedisStore from "connect-redis";

declare module "express-session" {
  interface SessionData {
    authenticated?: boolean;
    adminAuthenticated?: boolean;
    memberId?: string;
    memberEmail?: string;
  }
}

const PgSession = connectPgSimple(session);
const MemoryStore = createMemoryStore(session);

// Fix BigInt JSON serialization
(BigInt.prototype as any).toJSON = function () {
  return this.toString();
};

export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });
  console.log(`${formattedTime} [${source}] ${message}`);
}

export const app = express();

// â˜… [ìˆ˜ì • 2] Nginx í”„ë¡ì‹œ ì‹ ë¢° ì„¤ì • (í•„ìˆ˜)
app.set('trust proxy', 1);

declare module 'http' {
  interface IncomingMessage {
    rawBody: unknown
  }
}

// â˜… [ìˆ˜ì • 3] Redis URL ê°•ì œ ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ì—†ìœ¼ë©´ ë¡œì»¬í˜¸ìŠ¤íŠ¸ ì‚¬ìš©)
// ì´ë ‡ê²Œ í•´ì•¼ êµ¬ê¸€ ì„œë²„ì— ì„¤ì¹˜ëœ Redisë¥¼ 32ê°œ ì½”ì–´ê°€ ê°™ì´ ì”ë‹ˆë‹¤.
const REDIS_URL = process.env.REDIS_URL || "redis://localhost:6379";
const isProduction = process.env.NODE_ENV === "production" || true; // â˜… ê°•ì œë¡œ í”„ë¡œë•ì…˜ ëª¨ë“œ (HTTPS ì‚¬ìš© ìœ„í•´)

let sessionStore: session.Store;
let sessionStoreType: string;

// â˜… [ìˆ˜ì • 4] Redis ì—°ê²° ë¡œì§ ê°•í™”
// ì´ì œ ë¬´ì¡°ê±´ Redis ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.
console.log(`[Init] Attempting to connect to Redis at ${REDIS_URL}...`);

const redisClient = createClient({ url: REDIS_URL });

redisClient.on("error", (err) => {
  console.error("[Redis] Connection Error:", err);
});
redisClient.on("connect", () => {
  log("âœ… Redis connected successfully (Cluster Mode Ready)", "session");
});

// Redis í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹œì‘
redisClient.connect().catch(console.error);

// ì„¸ì…˜ ìŠ¤í† ì–´ë¡œ Redis ì§€ì •
sessionStore = new RedisStore({ 
  client: redisClient,
  prefix: "tburn:", // í‚¤ ì¶©ëŒ ë°©ì§€ìš© ì ‘ë‘ì‚¬
});
sessionStoreType = "Redis (Enterprise Cluster Mode)";

app.use(
  session({
    store: sessionStore,
    secret: process.env.SESSION_SECRET || "tburn-secret-key-change-in-production",
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true,   // â˜… HTTPS í•„ìˆ˜ (Nginx ë’¤ì— ìˆìœ¼ë¯€ë¡œ true)
      httpOnly: true, // ìë°”ìŠ¤í¬ë¦½íŠ¸ ì ‘ê·¼ ë°©ì§€ (ë³´ì•ˆ)
      maxAge: 24 * 60 * 60 * 1000, // 24ì‹œê°„
      sameSite: "lax", 
    },
    proxy: true, // â˜… Nginx í”„ë¡ì‹œ ì„¤ì •
  })
);

log(`Session store: ${sessionStoreType}`, "session");

const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD;
if (ADMIN_PASSWORD) {
  log(`âœ… ADMIN_PASSWORD loaded`, "security");
} else {
  log(`âš ï¸ WARNING: ADMIN_PASSWORD not set!`, "security");
}

app.use(express.json({
  verify: (req, _res, buf) => {
    req.rawBody = buf;
  }
}));
app.use(express.urlencoded({ extended: false }));

app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

jihun, [2025-12-22 ì˜¤í›„ 5:35]


  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }
      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "â€¦";
      }
      log(logLine);
    }
  });

  next();
});

export default async function runApp(
  setup: (app: Express, server: Server) => Promise<void>,
) {
  const server = await registerRoutes(app);

  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";
    res.status(status).json({ message });
    throw err;
  });

  await setup(app, server);

  const port = parseInt(process.env.PORT || '5000', 10);
  server.listen({
    port,
    host: "0.0.0.0",
    reusePort: true,
  }, () => {
    log(`serving on port ${port}`);
  });
}


---

### **âœ… ì ìš© í›„ í•  ì¼**

1. ìœ„ ì½”ë“œë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
2. deploy.sh`ê°€ **Cluster Mode(32ì½”ì–´)**ë¡œ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. (`instances: "max")
3. ì„œë²„ë¥¼ ì¬ë°°í¬í•©ë‹ˆë‹¤. (./deploy.sh)

**ì´ì œ ë¡œê·¸ë¥¼ ë³´ì‹œë©´ `âœ… Redis connected successfully`ê°€ ëœ° ê²ƒì´ê³ , 32ê°œ ì½”ì–´ ì–´ë””ë¡œ íŠ€ì–´ë„ ë¡œê·¸ì¸ì´ ì ˆëŒ€ ì•ˆ í’€ë¦´ ê²ë‹ˆë‹¤!**
import{p as y,r}from"./index-Aw_hmCPd.js";function f(){const a=y(),n=r.useRef(null),p=r.useRef(null),s=r.useRef(0),b=10,[w,c]=r.useState({isConnected:!1,lastUpdate:null,error:null,latestBlock:null,latestTransaction:null,networkStats:null}),l=r.useCallback(()=>{var o;if(((o=n.current)==null?void 0:o.readyState)===WebSocket.OPEN)return;const u=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;try{n.current=new WebSocket(u),n.current.onopen=()=>{var e;console.log("[ScanWS] Connected to server"),s.current=0,c(t=>({...t,isConnected:!0,error:null})),(e=n.current)==null||e.send(JSON.stringify({type:"subscribe",channels:["block_updates","network_stats","validators_update"]}))},n.current.onmessage=e=>{try{const t=JSON.parse(e.data);S(t)}catch(t){console.error("[ScanWS] Failed to parse message:",t)}},n.current.onclose=()=>{console.log("[ScanWS] Connection closed"),c(e=>({...e,isConnected:!1})),k()},n.current.onerror=e=>{console.error("[ScanWS] Error:",e),c(t=>({...t,error:"WebSocket connection error"}))}}catch(e){console.error("[ScanWS] Failed to create WebSocket:",e),k()}},[]),S=r.useCallback(i=>{const{type:u,data:o,timestamp:e}=i;switch(u){case"block_updates":case"new_block":c(t=>({...t,latestBlock:o,lastUpdate:e||Date.now()})),a.invalidateQueries({queryKey:["/api/public/v1/network/blocks/recent"]}),a.invalidateQueries({queryKey:["/api/public/v1/network/stats"]});break;case"new_transaction":c(t=>({...t,latestTransaction:o,lastUpdate:e||Date.now()})),a.invalidateQueries({queryKey:["/api/public/v1/network/transactions/recent"]});break;case"network_stats":c(t=>({...t,networkStats:o,lastUpdate:e||Date.now()})),a.invalidateQueries({queryKey:["/api/public/v1/network/stats"]});break;case"validators_update":a.invalidateQueries({queryKey:["/api/public/v1/validators"]});break}},[a]),k=r.useCallback(()=>{if(s.current>=b){c(e=>({...e,error:"Max reconnection attempts reached"}));return}const i=Math.min(1e3*Math.pow(2,s.current),3e4),u=Math.random()*1e3,o=i+u;s.current+=1,p.current=setTimeout(()=>{console.log(`[ScanWS] Reconnecting (attempt ${s.current})...`),l()},o)},[l]),d=r.useCallback(()=>{p.current&&clearTimeout(p.current),n.current&&(n.current.close(),n.current=null)},[]);return r.useEffect(()=>(l(),()=>d()),[l,d]),{...w,reconnect:l,disconnect:d}}export{f as u};
